{{ $curPage := . }}
{{ $curPage.Scratch.Set "match" 0 }}
{{ $curPage.Scratch.Set "nextPage" nil }}
{{ if .Site.Menus.site }}
  {{ $siteMenus := where .Site.Menus.main "Page" "ne" nil }}
  {{ range $siteMenus }}
    {{ $matched := $curPage.Scratch.Get "match" }}
    {{ if ne $matched 2 }}
      {{ if eq $matched 1 }}
         {{ $curPage.Scratch.Set "nextPage" . }}
         {{ $curPage.Scratch.Set "match" 2 }}
      {{ else }}
        {{ if eq $curPage .Page }}
          {{ $curPage.Scratch.Set "match" 1 }}
        {{ else }}
          {{ if .HasChildren }}
            {{ .Page.Scratch.Set "curPage" $curPage }}
            {{ partial "localnav-nextchild" . }}
          {{ end }}
        {{ end }}
      {{ end  }}
    {{ end }}
  {{ end }}
  {{ $matched := $curPage.Scratch.Get "match" }}
  {{ if ne $matched 2 }}
    {{ if $curPage.Parent }}
      {{ partial "localnav-findnextpage" $curPage.Parent }}
    {{ else }}
      Next
    {{ end }}
  {{ else }}
    {{ $nextPage := $curPage.Scratch.Get "nextPage" }}
    {{ if eq $nextPage $nextPage.Parent }}
      {{ partial "localnav-findnextpage" $nextPage.Parent }}
    {{ else }}
      {{ if $nextPage }}
        <a href="{{ $nextPage.URL | relURL }}">Next</a>
      {{ end }}
    {{ end }}
  {{ end }}
{{ else }}
  NoSiteMenu
{{ end }}
