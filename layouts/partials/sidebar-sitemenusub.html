<!-- Copyright 2018 Daniel F. Dickinson,
       Released under the Creative Commons 4.0 BY (Attribution) License -->
{{ $basePage := .Scratch.Get "BasePage" }}
{{ $maxLevel := .Scratch.Get "sidebarMaxLevel" }}
{{ $curLevel := .Scratch.Get "sidebarCurLevel" }}
{{ $nextLevel := (add 1 $curLevel) }}
{{ $nextSectionLevel := (add 2 $curLevel) }}
{{ if .Sections }}
  {{ $showItem := (not (eq .Params.notinmenu true) ) }}
  {{ range .Sections }}
    {{ $showItem := (not (eq .Params.notinmenu true) ) }}
    {{ $showPage := (and $showItem (or (and .IsPage (lt $curLevel $maxLevel)) (and (not .IsPage) (or (and (ne $basePage .) (lt $curLevel $maxLevel)) (and (eq $basePage .) (lt $curLevel $maxLevel) ) ) ) ) ) }}
    {{ $showSubmenu := (and $showItem (and (not .IsPage) (or (and (not (eq $basePage .)) (lt $nextLevel $maxLevel)) (and (eq $basePage .) (lt $curLevel $maxLevel) ) ) ) ) }}
    {{ .Scratch.Set "BasePage" $basePage }}
    {{ .Scratch.Set "sidebarMaxLevel" $maxLevel }}
    {{ if and (or (.Sections) (.Data.Pages)) $showSubmenu }}
      {{ .Scratch.Set "hasSubmenu" true }}
    {{ else }}
      {{ .Scratch.Set "hasSubmenu" false }}
    {{ end }}
    {{ if $showPage }}
      {{ partial "sitemenuitem" . }}
    {{ end }}
    {{ if $showSubmenu }}
      {{ if .Data.Pages }}
        {{ .Scratch.Set "BasePage" $basePage }}
        {{ .Scratch.Set "sidebarMaxLevel" $maxLevel }}
        {{ .Scratch.Set "sidebarCurLevel" $curLevel }}
        {{ partial "sidebar-sitemenusibs" . }}
      {{ end }}
      {{ if .Sections }}
        {{ .Scratch.Set "BasePage" $basePage }}
        {{ .Scratch.Set "sidebarMaxLevel" $maxLevel }}
        {{ .Scratch.Set "sidebarCurLevel" $nextLevel }}
        {{ partial "sidebar-sitemenusub" . }}
        </ul></li>
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
