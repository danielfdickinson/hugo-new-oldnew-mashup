<!-- Copyright 2018 Daniel F. Dickinson,
       Released under the Creative Commons 4.0 BY (Attribution) License -->
{{ $curItem := . }}
{{ $currentPage := .Scratch.Get "currentPage" }}
{{ $maxLevel := .Scratch.Get "maxLevel" }}
{{ $prevLevel := .Scratch.Get "prevLevel" }}
{{ $curLevel := add $prevLevel 1 }}
{{ $sections := .Scratch.Get "sections" }}
{{ if le $prevLevel $maxLevel }}
  {{ partial "menuitem" . }}
  {{ range $sections }}
    {{ .Scratch.Set "currentPage" $currentPage }}
    {{ .Scratch.Set "maxLevel" $maxLevel }}
    {{ .Scratch.Set "prevLevel" $curLevel }}
    {{ .Scratch.Set "sections" .Sections }}
    {{ if lt $prevLevel $maxLevel }}
      {{ .Scratch.Set "hasSubmenu" true }}
    {{ end }}
    {{ partial "menusub" . }}
    {{ if lt $prevLevel (sub $maxLevel 2) }}
      {{ partial "menusibs" . }}
    {{ end }}
    {{ if and (not .Sections) (lt $prevLevel $maxLevel) }}
      </ul></li>
    {{ end }}
  {{ end }}
{{ end }}
